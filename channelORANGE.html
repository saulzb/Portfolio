<script>
const SPACE_ID = '5w319pzc4eiq';
const ACCESS_TOKEN = 'l_S14vNHPLKqDVzZDxMSlO3g3AhMne9mAvyC74dyetg';
const CATEGORY_NAME = "channelORANGE";

let gallery = [];
let currentIndex = 0;

// ----- FETCH PHOTOS -----
async function fetchPhotos(){
  const res = await fetch(
    `https://cdn.contentful.com/spaces/${SPACE_ID}/entries?content_type=photo&access_token=${ACCESS_TOKEN}&include=1`
  );
  const data = await res.json();

  const assets = {};
  data.includes.Asset.forEach(a => assets[a.sys.id] = a.fields.file.url);

  gallery = data.items
    .filter(i => i.fields.category === CATEGORY_NAME)
    .map(i => `https:${assets[i.fields.photo.sys.id]}`);

  renderPhotos();
}

// ----- INTERSECTION OBSERVER FOR THUMBS -----
const thumbObserver = new IntersectionObserver(entries => {
  entries.forEach(entry => {
    if (!entry.isIntersecting) return;

    const img = entry.target;
    const src = img.dataset.src;
    const dpr = window.devicePixelRatio || 1;

    // 180px display × DPR × 2 (retina-safe, no waste)
    const requestWidth = Math.ceil(180 * dpr * 2);

    const highRes = new Image();
    highRes.decoding = "async";
    highRes.src = `${src}?w=${requestWidth}&fm=webp&q=85&fit=fill&fl=progressive`;
    highRes.onload = () => {
      img.src = highRes.src;
      img.classList.add("loaded");
    };

    thumbObserver.unobserve(img);
  });
}, { rootMargin: "200px" });

// ----- RENDER THUMBNAILS -----
function renderPhotos(){
  const row = document.createElement("div");
  row.className = "category-row";

  const isMobile = window.innerWidth <= 768;

  gallery.forEach((src,i)=>{
    const img = document.createElement("img");

    // Tiny placeholder (fast)
    img.src = `${src}?w=40&fm=webp&q=10`;
    img.dataset.src = src;
    img.loading = "lazy";
    img.decoding = "async";

    img.onclick = ()=>openLightbox(i);

    row.appendChild(img);
    thumbObserver.observe(img);
  });

  document.getElementById("photoSections").appendChild(row);
}

// ----- LIGHTBOX -----
const lightbox = document.getElementById("lightbox");
const lightboxImg = document.getElementById("lightbox-img");
const lightboxBg = document.getElementById("lightbox-bg");
const navLeft = document.querySelector(".nav-left");
const navRight = document.querySelector(".nav-right");

function openLightbox(i){
  currentIndex = i;
  lightbox.classList.add("show");

  const dpr = window.devicePixelRatio || 1;

  // Match actual viewport size (no upscaling)
  const targetSize = Math.ceil(
    Math.max(window.innerWidth, window.innerHeight) * dpr * 0.9
  );

  // Soft background
  lightboxBg.style.backgroundImage =
    `url(${gallery[i]}?w=60&fm=webp&q=10)`;

  const imgLarge = new Image();
  imgLarge.decoding = "async";
  imgLarge.src =
    `${gallery[i]}?w=${targetSize}&fm=webp&q=92&fit=fill&fl=progressive`;

  imgLarge.onload = () => {
    lightboxImg.src = imgLarge.src;
  };

  preloadNext(i);
}

// ----- PRELOAD NEXT ONLY (saves bandwidth) -----
function preloadNext(i){
  const nextIndex = (i+1) % gallery.length;
  const dpr = window.devicePixelRatio || 1;

  const targetSize = Math.ceil(
    Math.max(window.innerWidth, window.innerHeight) * dpr * 0.9
  );

  const imgPre = new Image();
  imgPre.src =
    `${gallery[nextIndex]}?w=${targetSize}&fm=webp&q=85&fit=fill`;
}

// ----- LIGHTBOX NAV -----
function next(){ openLightbox((currentIndex+1)%gallery.length); }
function prev(){ openLightbox((currentIndex-1+gallery.length)%gallery.length); }

navRight.onclick = next;
navLeft.onclick = prev;

lightbox.onclick = e => {
  if(e.target !== lightboxImg && !e.target.classList.contains('nav-mark')) {
    lightbox.classList.remove("show");
  }
};

document.addEventListener("keydown", e=>{
  if(!lightbox.classList.contains("show")) return;
  if(e.key==="ArrowRight") next();
  if(e.key==="ArrowLeft") prev();
  if(e.key==="Escape") lightbox.classList.remove("show");
});

// ----- MOBILE SWIPE (unchanged) -----
let startX = 0;
let startY = 0;
const swipeThreshold = 50;

lightboxImg.addEventListener('touchstart', e => {
  if (e.touches.length === 1) {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
  }
});

lightboxImg.addEventListener('touchend', e => {
  const endX = e.changedTouches[0].clientX;
  const endY = e.changedTouches[0].clientY;
  const deltaX = endX - startX;
  const deltaY = endY - startY;

  if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > swipeThreshold) {
    deltaX < 0 ? next() : prev();
  }
});

fetchPhotos();
</script>
